<span class="section-header">플레이 제어</span>
<div class="audio-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <button id="playBtn" class="btn-action"><i data-lucide="play" size="16"></i>재생 (Pos)</button>
    <button id="resetBtn" class="btn-action"><i data-lucide="arrow-down-to-line" size="16"></i>처음으로</button>
</div>

<script>
    let playStartTime = 0;
    let syncAnimFrame = null;

    /**
     * 플레이 모듈 초기화
     */
    function initPlay() {
        document.getElementById('playBtn').onclick = togglePlay;
        document.getElementById('resetBtn').onclick = () => { 
            stopPlayback(); 
            document.getElementById('viewport').scrollTop = currentChartHeight; 
            // 리셋 시 가상 렌더링 갱신
            if (typeof renderVisibleNotes === 'function') renderVisibleNotes();
        };

        // 초기 비트 표시선(그리드) 설정
        updateGridVisuals();
    }

    /**
     * 배속 및 BPM에 따른 비트 표시선(그리드) 업데이트
     */
    function updateGridVisuals() {
        const gridLayer = document.getElementById('gridLayer');
        if (gridLayer) {
            // 주 비트선(1비트)과 보조 비트선(1/4비트)을 위한 다중 배경 설정
            gridLayer.style.backgroundSize = `100% ${pixelsPerBeat}px, 100% ${pixelsPerBeat / 4}px`;
            gridLayer.style.backgroundImage = `
                linear-gradient(rgba(255, 255, 255, 0.25) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.08) 1px, transparent 1px)
            `;
            gridLayer.style.backgroundPosition = 'bottom';
        }
    }

    /**
     * 재생/정지 토글
     */
    function togglePlay() {
        if (isPlaying) { stopPlayback(); return; }
        if (!audioBuffer) return;

        const viewport = document.getElementById('viewport');
        // 현재 판정선(Hitline) 위치의 Y 좌표를 구함
        const currentHitlineY = viewport.scrollTop + viewport.clientHeight - HITLINE_OFFSET;
        
        // 현재 위치를 시간(초)으로 변환
        audioStartOffset = getTimeFromY(currentHitlineY);

        // 카운트다운 로직 등 추가 가능
        startAudio(audioStartOffset);
    }

    /**
     * 오디오 재생 시작
     */
    function startAudio(offset) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        sourceNode = audioCtx.createBufferSource();
        sourceNode.buffer = audioBuffer;
        
        // 오디오 설정 모듈의 재생 속도 반영
        const speedRange = document.getElementById('speedRange');
        const rate = speedRange ? parseFloat(speedRange.value) : 1.0;
        sourceNode.playbackRate.value = rate;
        
        sourceNode.connect(audioCtx.destination);
        
        isPlaying = true;
        playStartTime = audioCtx.currentTime;
        
        // 음수 오프셋(여백 구간) 처리
        if (offset < 0) {
            const delay = Math.abs(offset) / rate;
            sourceNode.start(audioCtx.currentTime + delay, 0);
        } else {
            sourceNode.start(0, offset);
        }

        document.getElementById('playBtn').innerHTML = '<i data-lucide="square" size="16"></i>정지 (ESC)';
        lucide.createIcons();
        
        syncAnimFrame = requestAnimationFrame(updateSync);
    }

    /**
     * 재생 중 스크롤 및 렌더링 동기화
     */
    function updateSync() {
        if (!isPlaying || !audioCtx) return;

        const speedRange = document.getElementById('speedRange');
        const rate = speedRange ? parseFloat(speedRange.value) : 1.0;
        
        // 경과 시간 계산 (재생 속도 반영)
        const elapsed = (audioCtx.currentTime - playStartTime) * rate;
        const currentSongTime = audioStartOffset + elapsed;
        
        // 노래 시간에 따른 현재 Y 좌표 계산
        const targetY = getYFromTime(currentSongTime);
        const viewport = document.getElementById('viewport');
        
        // 스크롤 위치를 판정선에 맞게 조정
        viewport.scrollTop = targetY - viewport.clientHeight + HITLINE_OFFSET;

        // 가상 렌더링 엔진 호출 (노트 로드/언로드)
        if (typeof renderVisibleNotes === 'function') renderVisibleNotes();

        if (currentSongTime < audioBuffer.duration + PADDING_SEC) {
            syncAnimFrame = requestAnimationFrame(updateSync);
        } else {
            stopPlayback();
        }
    }

    /**
     * 재생 정지 및 UI 복구
     */
    function stopPlayback() {
        if (sourceNode) {
            try { sourceNode.stop(); } catch(e) {}
            sourceNode = null;
        }
        isPlaying = false;
        cancelAnimationFrame(syncAnimFrame);
        
        document.getElementById('playBtn').innerHTML = '<i data-lucide="play" size="16"></i>재생 (Pos)';
        lucide.createIcons();
    }
</script>
